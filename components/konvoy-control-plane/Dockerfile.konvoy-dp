## build image
FROM golang:1.12.5
ENV GO111MODULE=on

WORKDIR /go/src/github.com/Kong/konvoy/components/konvoy-control-plane

# facilitate docker layer caching
COPY go.mod go.mod
COPY go.sum go.sum
COPY api/go.mod api/go.mod
COPY api/go.sum api/go.sum
COPY pkg/plugins/resources/k8s/native/go.mod pkg/plugins/resources/k8s/native/go.mod
COPY pkg/plugins/resources/k8s/native/go.sum pkg/plugins/resources/k8s/native/go.sum

RUN go mod download

COPY . .

RUN make build/konvoy-dp

## runtime image
FROM envoyproxy/envoy-alpine:latest

ENV PATH=$PATH:/konvoy-dataplane
COPY --from=0 /go/src/github.com/Kong/konvoy/components/konvoy-control-plane/build/artifacts/konvoy-dataplane/konvoy-dataplane /konvoy-dataplane/konvoy-dataplane

RUN addgroup -S -g 5678 konvoy-dataplane \
 && adduser -S -D -G konvoy-dataplane -u 5678 konvoy-dataplane

USER konvoy-dataplane

ENTRYPOINT ["konvoy-dataplane"]
CMD ["run"]
